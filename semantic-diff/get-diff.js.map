{"version":3,"file":"get-diff.js","sourceRoot":"","sources":["../src/semantic-diff/get-diff.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,aAAa,EAA+B,MAAM,kBAAkB,CAAC;AAC9E,OAAO,KAAK,cAAc,MAAM,qBAAqB,CAAC;AACtD,OAAO,EAAE,kBAAkB,EAAE,MAAM,wBAAwB,CAAC;AAC5D,OAAO,EAAE,YAAY,EAAE,MAAM,iBAAiB,CAAC;AAC/C,OAAO,EAAE,cAAc,EAAE,MAAM,oBAAoB,CAAC;AACpD,OAAO,EAAE,gBAAgB,EAAE,MAAM,sBAAsB,CAAC;AACxD,OAAO,EAAE,WAAW,EAAE,MAAM,iBAAiB,CAAC;AAK9C,MAAM,QAAQ,GAAI,cAAsB,CAAC,OAAO,CAAC;AAEjD;;;;;;;;GAQG;AACH,SAAS,gBAAgB,CAAC,QAAiB,EAAE,SAAkB,EAAE,IAAU;IACzE,MAAM,cAAc,GAAG,gBAAgB,CAAC,QAAQ,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;IAC7D,MAAM,eAAe,GAAG,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;IAE/D,OAAO;QACL,OAAO,EAAE,cAAc,CAAC,IAAI,EAAE,cAAc,EAAE,eAAe,CAAC;QAC9D,IAAI,EAAE,WAAW,CAAC,QAAQ,EAAE,IAAI,CAAC,IAAI,CAAC;KACvC,CAAC;AACJ,CAAC;AAOD;;;;;;;;;GASG;AACH,MAAM,UAAU,YAAY,CAAC,QAAgB,EAAE,SAAiB;IAC9D,MAAM,QAAQ,GAAG,aAAa,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CAAY,CAAC;IACxE,MAAM,SAAS,GAAG,aAAa,CAAC,kBAAkB,CAAC,SAAS,CAAC,CAAY,CAAC;IAE1E,YAAY,CAAC,QAAQ,CAAC,CAAC;IACvB,YAAY,CAAC,SAAS,CAAC,CAAC;IAExB,0DAA0D;IAC1D,MAAM,MAAM,GAAG,CAAC,IAAY,EAAE,GAAW,EAAE,EAAE,CAAC,GAAG,KAAK,YAAY,CAAA;IAClE,MAAM,KAAK,GAAG,QAAQ,CAAC,QAAQ,EAAE,SAAS,EAAE,MAAM,CAAuB,CAAC;IAE1E,IAAI,CAAC,KAAK,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE;QAC3B,OAAO,SAAS,CAAC;KAClB;IAED,OAAO,gBAAgB,CAAC,QAAQ,EAAE,SAAS,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;AACzD,CAAC;AAED;;;;;;GAMG;AACH,MAAM,UAAU,YAAY,CAAC,QAAgB,EAAE,SAAiB;IAC9D,MAAM,MAAM,GAAG,YAAY,CAAC,QAAQ,EAAE,SAAS,CAAC,CAAC;IAEjD,IAAI,MAAM,EAAE;QACV,MAAM,IAAI,KAAK,CAAC,GAAG,MAAM,CAAC,OAAO,cAAc,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC;KAC/D;AACH,CAAC","sourcesContent":["import { parseFragment, DefaultTreeDocumentFragment } from 'parse5-es-module';\nimport * as deepDiffModule from 'deep-diff-es-module';\nimport { sanitizeHtmlString } from './sanitize-html-string';\nimport { normalizeAST } from './normalize-ast';\nimport { getDiffMessage } from './get-diff-message';\nimport { findDiffedObject } from './find-diffed-object';\nimport { getDiffPath } from './get-diff-path';\nimport { ASTNode } from './types';\n\n// deep-diff types for the module is incorrect\ntype Diff = deepDiff.IDiff;\nconst deepDiff = (deepDiffModule as any).default;\n\n/**\n * Creates the DiffResult for two AST trees.\n *\n * @param leftTree the left tree\n * @param rightTree the right tree\n * @param diff the semantic difference between the two trees\n *\n * @returns the diff result containing the human readable semantic difference\n */\nfunction createDiffResult(leftTree: ASTNode, rightTree: ASTNode, diff: Diff): DiffResult {\n  const leftDiffObject = findDiffedObject(leftTree, diff.path);\n  const rightDiffObject = findDiffedObject(rightTree, diff.path);\n\n  return {\n    message: getDiffMessage(diff, leftDiffObject, rightDiffObject),\n    path: getDiffPath(leftTree, diff.path),\n  };\n}\n\ninterface DiffResult {\n  message: string;\n  path: string;\n}\n\n/**\n * Parses two HTML trees, and generates the semantic difference between the two trees.\n * The HTML is diffed semantically, not literally. This means that changes in attribute\n * and class order and whitespace/newlines are ignored. Also, script and style\n * tags ignored.\n *\n * @param leftHTML the left HTML tree\n * @param rightHTML the right HTML tree\n * @returns the diff result, or undefined if no diffs were found\n */\nexport function semanticDiff(leftHTML: string, rightHTML: string): DiffResult | undefined {\n  const leftTree = parseFragment(sanitizeHtmlString(leftHTML)) as ASTNode;\n  const rightTree = parseFragment(sanitizeHtmlString(rightHTML)) as ASTNode;\n\n  normalizeAST(leftTree);\n  normalizeAST(rightTree);\n\n  // parentNode causes a circular reference, so ignore them.\n  const ignore = (path: string, key: string) => key === 'parentNode'\n  const diffs = deepDiff(leftTree, rightTree, ignore) as Diff[] | undefined;\n\n  if (!diffs || !diffs.length) {\n    return undefined;\n  }\n\n  return createDiffResult(leftTree, rightTree, diffs[0]);\n}\n\n/**\n * Asserts that the two given HTML trees are semantically equal. See getDiff().\n * Throws a human readable error when there is a difference.\n *\n * @param leftHTML the left HTML tree\n * @param rightHTML the right HTML tree\n */\nexport function assertEquals(leftHTML: string, rightHTML: string) {\n  const result = semanticDiff(leftHTML, rightHTML);\n\n  if (result) {\n    throw new Error(`${result.message}, at path: ${result.path}`);\n  }\n}\n"]}